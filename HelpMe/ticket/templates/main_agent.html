{% extends 'base_main.html' %}

{% block title %}HelpME - Agent Dashboard{% endblock %}

{% block content %}
<div class="welcome">
  Hello Agent {{ request.user.first_name|default:request.user.username }}, here are all active tickets:
</div>

<div class="tickets-container">
  <div class="filters">
    <select id="priorityFilter" onchange="filterTickets()">
      <option value="">All Priorities</option>
      <option value="HIGH">High Priority</option>
      <option value="MEDIUM">Medium Priority</option>
      <option value="LOW">Low Priority</option>
    </select>
    <select id="statusFilter" onchange="filterTickets()">
      <option value="">All Status</option>
      <option value="OPEN">Open</option>
      <option value="IN_PROGRESS">In Progress</option>
      <option value="CLOSED">Closed</option>
    </select>
  </div>

  <div class="conversation-list">
    {% for ticket in tickets %}
    <div class="conversation" data-priority="{{ ticket.priority }}" data-status="{{ ticket.status }}" onclick="window.location.href='{% url 'chat' ticket.id %}'">
      <div class="conversation-header" onclick="toggleTicket(this.parentElement)">
        <div class="conversation-title">{{ ticket.title }}</div>
        <div class="conversation-creator">by {{ ticket.creator.get_full_name|default:ticket.creator.username }}</div>
        <div class="conversation-creator">Description: {{ ticket.description }}</div>
      </div>
      <div class="conversation-info">
        <span class="conversation-priority {{ ticket.priority|lower }}" style="padding: 3px 8px; border-radius: 4px; {% if ticket.priority == 'LOW' %}background: #28a745; color: white;{% elif ticket.priority == 'MEDIUM' %}background: #ffc107; color: black;{% else %}background: #dc3545; color: white;{% endif %}">{{ ticket.get_priority_display }}</span>
        <span class="conversation-status {{ ticket.status|lower }}" style="padding: 3px 8px; border-radius: 4px; {% if ticket.status == 'open' %}background: #17a2b8; color: white;{% elif ticket.status == 'in_progress' %}background: #007bff; color: white;{% else %}background: #6c757d; color: white;{% endif %}">{{ ticket.get_status_display }}</span>
        <span class="conversation-date">{{ ticket.created_at|date:"Y-m-d H:i" }}</span>
      </div>
    </div>
    {% empty %}
    <div class="no-tickets">
      No tickets available at the moment.
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterTickets() {
  const priorityFilter = document.getElementById('priorityFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;
  const tickets = document.querySelectorAll('.conversation');

  tickets.forEach(ticket => {
    const priority = ticket.dataset.priority;
    const status = ticket.dataset.status;
    const shouldShow = (!priorityFilter || priority === priorityFilter) && 
                      (!statusFilter || status === statusFilter);
    ticket.style.display = shouldShow ? 'block' : 'none';
  });
}

function toggleTicket(ticketElement) {
  const details = ticketElement.querySelector('.ticket-details');
  const isHidden = details.style.display === 'none';
  details.style.display = isHidden ? 'block' : 'none';
}
</script>
{% endblock %}