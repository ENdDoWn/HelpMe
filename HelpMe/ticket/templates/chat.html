{% extends 'base_main.html' %}

{% load static %}

{% block title %}HelpME - Chat{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block extra_js %}
<script>
  // Request notification permission
  document.addEventListener('DOMContentLoaded', function() {
      if (Notification.permission !== 'granted') {
          Notification.requestPermission();
      }
  });

  function showNotification(message, username, ticketTitle) {
      if (Notification.permission === "granted" && document.hidden) {
          const notification = new Notification(ticketTitle, {
              body: `${username}: ${message}`,
              icon: '/static/images/logo.png'
          });

          notification.onclick = function() {
              window.focus();
              this.close();
          };
      }
  }

  let chatSocket = null;
  const messagesContainer = document.querySelector('.messages');
  const messageInput = document.querySelector('#messageInput');
  const chatForm = document.querySelector('#chatForm');
  const fileInput = document.querySelector('#fileInput');
  const dropZone = document.querySelector('.chat-body');

  // Drag and drop functionality
  let dragCounter = 0;

  dropZone.addEventListener('dragenter', function(e) {
    e.preventDefault();
    dragCounter++;
    dropZone.classList.add('drag-over');
  });

  dropZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    dragCounter--;
    if (dragCounter === 0) {
      dropZone.classList.remove('drag-over');
    }
  });

  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dragCounter = 0;
    dropZone.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      uploadFile(files[0]);
    }
  });

  // File upload function
  function uploadFile(file) {
    // Check file size (10MB limit)
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
      alert('File size too large. Maximum 10MB allowed.');
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    // Show uploading message
    showUploadingMessage(file.name);

    fetch(`/ticket/{{ ticket.id }}/upload/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // File uploaded successfully - message will be sent via WebSocket by the server
        console.log('File uploaded successfully:', data.file_name);
      } else {
        alert('Upload failed: ' + (data.error || 'Unknown error'));
      }
      removeUploadingMessage();
    })
    .catch(error => {
      console.error('Upload error:', error);
      alert('Upload failed: ' + error.message);
      removeUploadingMessage();
    });
  }

  function showUploadingMessage(fileName) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message self uploading';
    messageDiv.innerHTML = `
      <div class="sender">{{ request.user.username }}</div>
      <div class="text">
        üì§ Uploading ${fileName}...
        <span class="time">now</span>
      </div>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function removeUploadingMessage() {
    const uploadingMsg = document.querySelector('.message.uploading');
    if (uploadingMsg) {
      uploadingMsg.remove();
    }
  }

  // File input change handler
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        uploadFile(e.target.files[0]);
        e.target.value = ''; // Reset input
      }
    });
  }

  function connectWebSocket() {
    const wsUrl = 'ws://' + window.location.host + '/ws/chat/{{ ticket.id }}/';
    console.log('Attempting WebSocket connection to:', wsUrl);
    if (chatSocket) {
        chatSocket.close();
    }

    try {
        chatSocket = new WebSocket(wsUrl);
        let pingInterval;

    chatSocket.onopen = function(e) {
      console.log('WebSocket connection established');
      reconnectAttempts = 0;
      messageInput.disabled = false;
      messageInput.placeholder = 'Type your message...';

      // send ping every 30 seconds
      pingInterval = setInterval(() => {
        if (chatSocket.readyState === WebSocket.OPEN) {
          chatSocket.send(JSON.stringify({ 'type': 'ping' }));
        }
      }, 30000);
    };

    chatSocket.onmessage = function(e) {
      try {
        const data = JSON.parse(e.data);
        // Handle ping/pong
        if (data.type === 'pong') {
            console.log('Received pong from server');
            return;
        }
        
        if (data.error) {
          console.error('Message error:', data.error);
          return;
        }

        const message = data.message;
        const username = data.username;
        const timestamp = data.timestamp || new Date().toLocaleString();
        const isCurrentUser = username === '{{ request.user.username }}';
        const isFile = data.is_file || false;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isCurrentUser ? 'self' : 'other'}`;

        const senderDiv = document.createElement('div');
        senderDiv.className = 'sender';
        senderDiv.textContent = username;

        const textDiv = document.createElement('div');
        textDiv.className = 'text';
        
        if (isFile) {
          textDiv.innerHTML = `
            <div class="file-message">
              <i class="file-icon">üìé</i>
              <span class="file-name">${data.file_name}</span>
            </div>
          `;
        } else {
          textDiv.textContent = message;
        }

        const timeSpan = document.createElement('span');
        timeSpan.className = 'time';
        timeSpan.textContent = timestamp;

        textDiv.appendChild(timeSpan);
        messageDiv.appendChild(senderDiv);
        messageDiv.appendChild(textDiv);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Show notification for new messages
        if (Notification.permission === 'granted' && document.hidden) {
          const notification = new Notification('New Message in Ticket', {
            body: `${username}: ${message}`,
            icon: '/static/images/logo.png',
          });
          
          notification.onclick = function() {
            window.focus();
            this.close();
          };
        }
      } catch (error) {
        console.error('Error processing message:', error);
      }
    };

    chatSocket.onclose = function(e) {
      console.log('WebSocket closed. Code:', e.code, 'Reason:', e.reason);
      if (pingInterval) {
        clearInterval(pingInterval);
      }
    };
    } catch (error) {
      console.error('Error creating WebSocket connection:', error);
      messageInput.disabled = true;
      messageInput.placeholder = 'Connection failed. Please refresh the page.';
    }
  }

  chatForm.onsubmit = function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
      chatSocket.send(JSON.stringify({
        'message': message
      }));
      messageInput.value = '';
    }
  };
  connectWebSocket();

  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  window.onbeforeunload = function() {
    if (chatSocket) {
      chatSocket.close();
    }
  };
</script>
{% endblock %}

{% block content %}
<div class="chat-container">
  <div class="chat-body">
    <div class="chat-header">
      <a href="{% if request.user.groups.all.0.name == 'Agents' %}{% url 'main_agent' %}{% else %}{% url 'main_user' %}{% endif %}" class="back-btn">
        <button style="text-decoration: none; border: none; background: none; color: white; font-size: 16px; cursor: pointer;">‚Üê
          Back
        </button>
      </a>
      <h2>{{ ticket.title }}</h2>
    </div>

    <div class="messages">
      {% for message in messages %}
        <div class="message {% if message.user == request.user %}self{% else %}other{% endif %}">
          <div class="sender">{{ message.user.get_full_name|default:message.user.username }}</div>
          <div class="text">
            {% if message.is_file_message %}
              <div class="file-message">
                <i class="file-icon">üìé</i>
                <a href="{{ message.file.url }}" target="_blank" class="file-name">
                  {{ message.file_name }}
                </a>
              </div>
            {% else %}
              {{ message.msg }}
            {% endif %}
            <span class="time">{{ message.created_at|date:"h:i A d/M/Y" }}</span>
          </div>
        </div>
      {% empty %}
      {% endfor %}
    </div>

    <form class="chat-input" id="chatForm">
      {% csrf_token %}
      <input type="file" id="fileInput" style="display: none;" accept="*/*">
      <button type="button" class="file-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
      <input type="text" id="messageInput" placeholder="Type your message or drag & drop files..." required>
      <button type="submit">‚û§</button>
    </form>
  </div>

  <div class="ticket-info">
    <h3>Ticket Information</h3>
    <div>
      <label>Created on</label>
      <div class="value">{{ ticket.created_at|date:"d M Y, h:i A" }}</div>
    </div>
    <div>
      <label>Priority</label>
      <div class="priority {{ ticket.priority|lower }}">{{ ticket.get_priority_display }}</div>
    </div>
    <div>
      <label>Status</label>
      <div class="value">{{ ticket.get_status_display }}</div>
    </div>
    <div>
      <label>Owner</label>
      <div class="value">{{ ticket.creator.get_full_name|default:ticket.creator.username }}</div>
    </div>
    <div>
      <label>Description</label>
      <div class="value" style="white-space: pre-wrap;">{{ ticket.description }}</div>
    </div>
    {% if request.user.groups.all.0.name == 'Agents' and ticket.status != 'closed' %}
    <div class="ticket-actions">
      <form action="{% url 'close_ticket' ticket.id %}" method="post" style="margin-top: 20px;">
        {% csrf_token %}
        <button type="submit" class="close-ticket-btn" style="background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Close Ticket</button>
      </form>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
