{% extends 'base_main.html' %}

{% load static %}

{% block title %}HelpME - Chat{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block extra_js %}
<script>
  // Request notification permission
  document.addEventListener('DOMContentLoaded', function() {
      if (Notification.permission !== 'granted') {
          Notification.requestPermission();
      }
  });

  function showNotification(message, username, ticketTitle) {
      if (Notification.permission === "granted" && document.hidden) {
          const notification = new Notification(ticketTitle, {
              body: `${username}: ${message}`,
              icon: '/static/images/logo.png'
          });

          notification.onclick = function() {
              window.focus();
              this.close();
          };
      }
  }

  let chatSocket = null;
  const messagesContainer = document.querySelector('.messages');
  const messageInput = document.querySelector('#messageInput');
  const chatForm = document.querySelector('#chatForm');

  function connectWebSocket() {
    const wsUrl = 'ws://' + window.location.host + '/ws/chat/{{ ticket.id }}/';
    console.log('Attempting WebSocket connection to:', wsUrl);
    if (chatSocket) {
        chatSocket.close();
    }

    try {
        chatSocket = new WebSocket(wsUrl);
        let pingInterval;

    chatSocket.onopen = function(e) {
      console.log('WebSocket connection established');
      reconnectAttempts = 0;
      messageInput.disabled = false;
      messageInput.placeholder = 'Type your message...';

      // send ping every 30 seconds
      pingInterval = setInterval(() => {
        if (chatSocket.readyState === WebSocket.OPEN) {
          chatSocket.send(JSON.stringify({ 'type': 'ping' }));
        }
      }, 30000);
    };

    chatSocket.onmessage = function(e) {
      try {
        const data = JSON.parse(e.data);
        // Handle ping/pong
        if (data.type === 'pong') {
            console.log('Received pong from server');
            return;
        }
        
        if (data.error) {
          console.error('Message error:', data.error);
          return;
        }

        const message = data.message;
        const username = data.username;
        const timestamp = data.timestamp || new Date().toLocaleString();
        const isCurrentUser = username === '{{ request.user.username }}';

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isCurrentUser ? 'self' : 'other'}`;

        const senderDiv = document.createElement('div');
        senderDiv.className = 'sender';
        senderDiv.textContent = username;

        const textDiv = document.createElement('div');
        textDiv.className = 'text';
        textDiv.textContent = message;

        const timeSpan = document.createElement('span');
        timeSpan.className = 'time';
        timeSpan.textContent = timestamp;

        textDiv.appendChild(timeSpan);
        messageDiv.appendChild(senderDiv);
        messageDiv.appendChild(textDiv);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Show notification for new messages
        if (Notification.permission === 'granted' && document.hidden) {
          const notification = new Notification('New Message in Ticket', {
            body: `${username}: ${message}`,
            icon: '/static/images/logo.png', // Add your logo path here
          });
          
          notification.onclick = function() {
            window.focus();
            this.close();
          };
        }
      } catch (error) {
        console.error('Error processing message:', error);
      }
    };

    chatSocket.onclose = function(e) {
      console.log('WebSocket closed. Code:', e.code, 'Reason:', e.reason);
      if (pingInterval) {
        clearInterval(pingInterval);
      }
    };
    } catch (error) {
      console.error('Error creating WebSocket connection:', error);
      messageInput.disabled = true;
      messageInput.placeholder = 'Connection failed. Please refresh the page.';
    }
  }

  chatForm.onsubmit = function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
      chatSocket.send(JSON.stringify({
        'message': message
      }));
      messageInput.value = '';
    }
  };
  connectWebSocket();

  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  window.onbeforeunload = function() {
    if (chatSocket) {
      chatSocket.close();
    }
  };
</script>
{% endblock %}

{% block content %}
<div class="chat-container">
  <div class="chat-body">
    <div class="chat-header">
      <a href="{% if request.user.groups.all.0.name == 'Agents' %}{% url 'main_agent' %}{% else %}{% url 'main_user' %}{% endif %}" class="back-btn">
        <button style="text-decoration: none; border: none; background: none; color: white; font-size: 16px; cursor: pointer;">←
          Back
        </button>
      </a>
      <h2>{{ ticket.title }}</h2>
    </div>

    <div class="messages">
      {% for message in messages %}
        <div class="message {% if message.user == request.user %}self{% else %}other{% endif %}">
          <div class="sender">{{ message.user.get_full_name|default:message.user.username }}</div>
          <div class="text">
            {{ message.msg }}
            <span class="time">{{ message.created_at|date:"h:i A d/M/Y" }}</span>
          </div>
        </div>
      {% empty %}
      {% endfor %}
    </div>

    <form class="chat-input" id="chatForm">
      {% csrf_token %}
      <input type="text" id="messageInput" placeholder="Type your message..." required>
      <button type="submit">➤</button>
    </form>
  </div>

  <div class="ticket-info">
    <h3>Ticket Information</h3>
    <div>
      <label>Created on</label>
      <div class="value">{{ ticket.created_at|date:"d M Y, h:i A" }}</div>
    </div>
    <div>
      <label>Priority</label>
      <div class="priority {{ ticket.priority|lower }}">{{ ticket.get_priority_display }}</div>
    </div>
    <div>
      <label>Status</label>
      <div class="value">{{ ticket.get_status_display }}</div>
    </div>
    <div>
      <label>Owner</label>
      <div class="value">{{ ticket.creator.get_full_name|default:ticket.creator.username }}</div>
    </div>
    <div>
      <label>Description</label>
      <div class="value" style="white-space: pre-wrap;">{{ ticket.description }}</div>
    </div>
    {% if request.user.groups.all.0.name == 'Agents' and ticket.status != 'closed' %}
    <div class="ticket-actions">
      <form action="{% url 'close_ticket' ticket.id %}" method="post" style="margin-top: 20px;">
        {% csrf_token %}
        <button type="submit" class="close-ticket-btn" style="background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Close Ticket</button>
      </form>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
